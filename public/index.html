<!DOCTYPE html>
<html>
<head>
    <title>Главная страница</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Добро пожаловать!</h1>
            <p>Система авторизации и выбора автомобилей</p>
        </div>
        
        <div class="content">
            <div id="auth-status">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let currentEditCarId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthStatus();
        });

        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                showLoginView();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    showAuthenticatedView(userData);
                } else {
                    localStorage.removeItem('token');
                    showLoginView();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                localStorage.removeItem('token');
                showLoginView();
            }
        }

        function showLoginView() {
            document.getElementById('auth-status').innerHTML = `
                <div class="user-info">
                    <h2>Вы не авторизованы</h2>
                    <p>Для доступа к системе выполните вход или зарегистрируйтесь</p>
                    
                    <div class="auth-buttons">
                        <a href="login.html">Войти</a>
                        <a href="register.html">Регистрация</a>
                    </div>
                </div>
            `;
        }

        async function showAuthenticatedView(userData) {
            document.getElementById('auth-status').innerHTML = `
                <div class="user-info">
                    <div class="avatar">${userData.username.charAt(0).toUpperCase()}</div>
                    <h2>Добро пожаловать, ${userData.username}!</h2>
                    <p>Вы можете выбрать автомобиль из списка ниже</p>
                    
                    <div class="car-section">
                        <h3>Добавить автомобиль</h3>
                        
                        <div class="form-group">
                            <label for="brand-select">Марка автомобиля:</label>
                            <select id="brand-select" onchange="loadCarModels(this.value)">
                                <option value="">-- Выберите марку --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="model-select">Модель автомобиля:</label>
                            <select id="model-select" disabled>
                                <option value="">-- Сначала выберите марку --</option>
                            </select>
                        </div>
                        
                        <div class="button-group">
                            <button id="add-car-btn" onclick="addUserCar()" class="btn-primary">
                                Добавить автомобиль
                            </button>
                            <button id="update-car-btn" onclick="updateUserCar()" class="btn-success" style="display: none;">
                                Сохранить изменения
                            </button>
                            <button onclick="cancelEdit()" class="btn-secondary" style="display: none;">
                                Отмена
                            </button>
                        </div>
                    </div>
                    
                    <div class="user-cars-section">
                        <h3>Мои автомобили</h3>
                        <div id="cars-list" class="cars-list">
                            <div class="loading">Загрузка автомобилей...</div>
                        </div>
                    </div>
                    
                    <button onclick="logout()" class="logout-btn">
                        Выйти из системы
                    </button>
                </div>
            `;

            await loadBrands();
            await loadUserCars();
        }

        // ========== API Функции ==========

        async function loadBrands() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/cars/brands`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки марок автомобилей');
                }

                const brands = await response.json();
                const brandSelect = document.getElementById('brand-select');

                brandSelect.innerHTML = '<option value="">-- Выберите марку --</option>';
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.uuid;
                    option.textContent = brand.name;
                    brandSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading brands:', error);
                showAlert('Ошибка загрузки марок автомобилей', 'error');
            }
        }

        async function loadCarModels(brandUuid) { 
            const modelSelect = document.getElementById('model-select');

            if (!brandUuid) {
                modelSelect.disabled = true;
                modelSelect.innerHTML = '<option value="">-- Сначала выберите марку --</option>';
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/cars/brands/${brandUuid}/models`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки моделей');
                }

                const models = await response.json();
                modelSelect.disabled = false;
                modelSelect.innerHTML = '<option value="">-- Выберите модель --</option>';

                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.uuid;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading models:', error);
                showAlert('Ошибка загрузки моделей автомобилей', 'error');
            }
        }

        async function loadUserCars() {
            try {
                const token = localStorage.getItem('token');
                
                // ИСПРАВЛЕНО: правильный endpoint
                const response = await fetch(`${API_URL}/cars/my-cars`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки автомобилей');
                }

                const cars = await response.json();
                console.log('Loaded cars:', cars);
                
                const carsList = document.getElementById('cars-list');

                if (!cars || cars.length === 0) {
                    carsList.innerHTML = '<div class="no-cars">У вас пока нет сохраненных автомобилей</div>';
                    return;
                }

                carsList.innerHTML = cars.map(car => `
                    <div class="car-item">
                        <div class="car-details">
                            <div class="car-brand-model">
                                ${car.brand ? car.brand.name : 'Неизвестно'} 
                                ${car.model ? car.model.name : 'Неизвестно'}
                            </div>
                            <div class="car-date">
                                Добавлено: ${new Date(car.selectedAt || car.created_at).toLocaleDateString('ru-RU')}
                            </div>
                        </div>
                        <div class="car-actions">
                            <button onclick="editCar('${car.uuid}', '${car.brand ? car.brand.uuid : ''}', '${car.model ? car.model.uuid : ''}')" 
                                    class="btn-edit">Редактировать</button>
                            <button onclick="deleteCar('${car.uuid}')" 
                                    class="btn-delete">Удалить</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading user cars:', error);
                const carsList = document.getElementById('cars-list');
                carsList.innerHTML = '<div class="no-cars">Ошибка загрузки автомобилей</div>';
            }
        }

        async function addUserCar() {
            const brandUuid = document.getElementById('brand-select').value;
            const modelUuid = document.getElementById('model-select').value;

            if (!brandUuid || !modelUuid) {
                showAlert('Пожалуйста, выберите марку и модель автомобиля', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                
                // ИСПРАВЛЕНО: правильный endpoint
                const response = await fetch(`${API_URL}/cars/my-cars`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        brand_uuid: brandUuid,
                        model_uuid: modelUuid
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Ошибка добавления автомобиля');
                }

                resetForm();
                await loadUserCars();
                showAlert('Автомобиль успешно добавлен!', 'success');
            } catch (error) {
                console.error('Error adding car:', error);
                showAlert(error.message || 'Ошибка при добавлении автомобиля', 'error');
            }
        }

        async function editCar(carUuid, brandUuid, modelUuid) {
            currentEditCarId = carUuid;

            document.getElementById('brand-select').value = brandUuid;
            await loadCarModels(brandUuid);

            setTimeout(() => {
                document.getElementById('model-select').value = modelUuid;
            }, 300);

            document.getElementById('add-car-btn').style.display = 'none';
            document.getElementById('update-car-btn').style.display = 'block';
            document.querySelector('.btn-secondary').style.display = 'block';
        }

        async function updateUserCar() {
            if (!currentEditCarId) return;

            const brandUuid = document.getElementById('brand-select').value;
            const modelUuid = document.getElementById('model-select').value;

            if (!brandUuid || !modelUuid) {
                showAlert('Пожалуйста, выберите марку и модель автомобиля', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                
                const response = await fetch(`${API_URL}/cars/my-cars/${currentEditCarId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        brand_uuid: brandUuid,
                        model_uuid: modelUuid
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Ошибка обновления автомобиля');
                }

                cancelEdit();
                await loadUserCars();
                showAlert('Автомобиль успешно обновлен!', 'success');
            } catch (error) {
                console.error('Error updating car:', error);
                showAlert(error.message || 'Ошибка при обновлении автомобиля', 'error');
            }
        }

        function cancelEdit() {
            currentEditCarId = null;
            resetForm();

            document.getElementById('add-car-btn').style.display = 'block';
            document.getElementById('update-car-btn').style.display = 'none';
            document.querySelector('.btn-secondary').style.display = 'none';
        }

        function resetForm() {
            document.getElementById('brand-select').value = '';
            document.getElementById('model-select').value = '';
            document.getElementById('model-select').disabled = true;
            document.getElementById('model-select').innerHTML = '<option value="">-- Сначала выберите марку --</option>';
        }

        async function deleteCar(carUuid) {
            if (!confirm('Вы уверены, что хотите удалить этот автомобиль?')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                
                // ИСПРАВЛЕНО: правильный endpoint
                const response = await fetch(`${API_URL}/cars/my-cars/${carUuid}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Ошибка удаления автомобиля');
                }

                await loadUserCars();
                showAlert('Автомобиль успешно удален!', 'success');
            } catch (error) {
                console.error('Error deleting car:', error);
                showAlert(error.message || 'Ошибка при удалении автомобиля', 'error');
            }
        }

        function showAlert(message, type = 'success') {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>